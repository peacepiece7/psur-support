<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.service.demo.domain.commoncode.mapper.CommonCodeMapper">

  <resultMap id="CommonCodeGroupMap" type="com.service.demo.domain.commoncode.entity.CommonCodeGroupEntity">
    <id property="id" column="id"/>
    <result property="groupCode" column="group_code"/>
    <result property="groupName" column="group_name"/>
    <result property="parentGroupId" column="parent_group_id"/>
    <result property="level" column="level"/>
    <result property="sortOrder" column="sort_order"/>
    <result property="description" column="description"/>
  </resultMap>

  <resultMap id="CommonCodeMap" type="com.service.demo.domain.commoncode.entity.CommonCodeEntity">
    <id property="id" column="id"/>
    <result property="groupId" column="group_id"/>
    <result property="code" column="code"/>
    <result property="codeName" column="code_name"/>
    <result property="childGroupCode" column="child_group_code"/>
    <result property="sortOrder" column="sort_order"/>
    <result property="isActive" column="is_active"/>
    <result property="description" column="description"/>
  </resultMap>

  <select id="findGroupByCode" resultMap="CommonCodeGroupMap">
    SELECT * FROM common_code_group
    WHERE group_code = #{groupCode}
      AND deleted_at IS NULL
    <if test="includeInactive == false">
      AND is_active = 1
    </if>
  </select>

  <select id="findAllGroups" resultMap="CommonCodeGroupMap">
    SELECT * FROM common_code_group
    WHERE is_active = 1
      AND deleted_at IS NULL
    ORDER BY level, sort_order, id
  </select>

  <select id="findGroupsFiltered" resultMap="CommonCodeGroupMap">
    SELECT * FROM common_code_group
    WHERE deleted_at IS NULL
    <if test="includeInactive == false">
      AND is_active = 1
    </if>
    <if test="name != null and name != ''">
      AND (
        group_name LIKE CONCAT('%', #{name}, '%')
        OR group_code LIKE CONCAT('%', #{name}, '%')
      )
    </if>
    ORDER BY ${sortColumn} ${sortDirection}, id ASC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="findRootGroups" resultMap="CommonCodeGroupMap">
    SELECT * FROM common_code_group
    WHERE parent_group_id IS NULL
      AND is_active = 1
      AND deleted_at IS NULL
    ORDER BY sort_order, id
  </select>

  <select id="findGroupsByParentId" resultMap="CommonCodeGroupMap">
    SELECT * FROM common_code_group
    WHERE parent_group_id = #{parentId}
      AND is_active = 1
      AND deleted_at IS NULL
    ORDER BY sort_order, id
  </select>

  <select id="findGroupsByParentIds" resultMap="CommonCodeGroupMap">
    SELECT * FROM common_code_group
    WHERE parent_group_id IN
    <foreach collection="parentIds" item="id" open="(" close=")" separator=",">
      #{id}
    </foreach>
      AND deleted_at IS NULL
    <if test="includeInactive == false">
      AND is_active = 1
    </if>
    ORDER BY sort_order, id
  </select>

  <select id="findCodesByGroupIds" resultMap="CommonCodeMap">
    SELECT * FROM common_code
    WHERE group_id IN
    <foreach collection="groupIds" item="id" open="(" close=")" separator=",">
      #{id}
    </foreach>
      AND deleted_at IS NULL
    <if test="includeInactive == false">
      AND is_active = 1
    </if>
    ORDER BY sort_order, id
  </select>

  <insert id="insertCode">
    INSERT INTO common_code (
      group_id,
      code,
      code_name,
      child_group_code,
      sort_order,
      is_active,
      description
    )
    VALUES (
      #{groupId},
      #{code},
      #{codeName},
      #{childGroupCode},
      #{sortOrder},
      #{isActive},
      #{description}
    )
  </insert>

  <update id="softDeleteCode">
    UPDATE common_code c
    JOIN common_code_group g ON c.group_id = g.id
    SET c.deleted_at = NOW(),
        c.is_active = 0
    WHERE g.group_code = #{groupCode}
      AND c.code = #{code}
      AND c.deleted_at IS NULL
  </update>

</mapper>
